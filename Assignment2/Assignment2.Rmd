---
title: "Assignment II"
author: "Group2"
date: "`r Sys.Date()`"
output:
  pdf_document
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#install.packages("pacman")
pacman::p_load(tidyverse,rms,haven,mgcv,epitools,logistf,nlpred,geepack,skimr,pROC,tableone,emmeans,glmtoolbox,CalibrationCurves,mice, dcurves)
library(tableone)
```

# Introduction

---

# Question 1:

Create table 1. Describe all available variables in the data. Show both, the original data and the imputed data. 

## Overview : 

All available variables in the data are as follows:

- *dibpat0f:* Dichotomous behavior pattern factor with levels A and B instead of 1 and 0.
- *agegroup:* Categories for age.
- *smoker:*  Binary variable for smoker or not.
- *smokerf:*  Smoker factor with levels No and Yes.
- *heightcm:* Convert height from inches to cm.
- *weightkg:* Convert weight from pounds to kg.
- *bmi:* Calculate BMI.
- *bmicat:* Categories for BMI.
- *cholmmol:* Convert cholesterol from mg/dl to mmol/l.
- *sbp10:*  Categories of sbp (systolic blood pressure).
- *sbpcat:* Systolic blood pressure factor.
- *chd69f:* Coronary heart disease factor.

Then, we have created tables for the original data. In the next step, we have imputed the data using Multivariate Imputation and created tables for the imputed data.

## Code :

```{r echo=FALSE}
# read in the data
data(wcgs)
# create factors from var ditpat0 with levels B and A in stead of 0 and 1 
wcgs$dibpat0f<-factor(wcgs$dibpat0,levels=0:1,label=c("B","A"))
# create categories for age
wcgs$agegroup <- cut(wcgs$age0,breaks=c(39,45,55,60),include.lowest = T,right = FALSE) 
# binary variable for smoker or not
wcgs$smoker <- ifelse(wcgs$ncigs0>0,1,0)
wcgs$smokerf <- factor(wcgs$smoker,levels=c(0,1),labels=c("No","Yes"))
# convert height from inches to cm
wcgs$heightcm <- wcgs$height0*2.54
wcgs$weightkg <- wcgs$weight0*0.45359237
wcgs$bmi <- wcgs$weightkg / (wcgs$heightcm/100)^2
wcgs$bmicat <- cut(wcgs$bmi,breaks=c(0,25,30,40),include.lowest = T,right = FALSE)
wcgs$cholmmol <- wcgs$chol0/39
wcgs$sbp10 <- wcgs$sbp0/10
# Create categories of sbp (systolic blood pressure). Make sure to have the lowest and highest numbers
wcgs$sbpcat <- cut(wcgs$sbp0,breaks=c(0,140,240),include.lowest = T,right = FALSE) # For use when tabulating the data you can create labels
wcgs$chd69f <- factor(wcgs$chd69,levels=c(0,1),labels=c("No","Yes")) 
wcgs$cholmmol <- ifelse(wcgs$cholmmol<15,wcgs$cholmmol,NA)

d <- wcgs %>% select(id,agegroup,age0,cholmmol,sbp10,bmi,smokerf,arcus0,dibpat0f,chd69)
dc <- d %>% drop_na()


set.seed(154550)
imp <- mice(d, m=1, maxit=0)
predM<-imp$predictorMatrix
# Leave out the ID column (the first column)
predM[, 1] <- 0
meth<-imp$method
dimp <- mice(d, method= "pmm" ,m=1,predictorMatrix = predM, maxit=15, seed=71332, print=FALSE)
di <- complete(dimp,1)
             
#di[is.na(d$cholmmol),"cholmmol"]
```

```{r}
# Define variables
variables <- c("id", "agegroup", "age0", "cholmmol", "sbp10", "bmi", "smokerf",
               "arcus0", "dibpat0f", "chd69")
categorical <- c("smokerf", "dibpat0f", "chd69")

# Create Table 1 for the original data
table_original <- CreateTableOne(vars = variables, data = wcgs, factorVars = categorical)

# Create Table 1 for the imputed data
table_imputed <- CreateTableOne(vars = variables, data = di, factorVars = categorical)
```

## Output : 

```{r echo=FALSE}
# Print summary for comparison
summary(table_original)
summary(table_imputed)
```

## Conclusion : 

The imputed data has been created using Multivariate Imputation where the missing data of cholmmol has been imputed. The imputed data has been created using Predictive Mean Matching (PMM) method. 

# Question 2

Calculate the overall risk of CHD in the cohort.

## Overview : 

*a. What is the outcome we are interested in?*

The outcome we are interested in is Coronary Heart Disease (CHD).

*b. What are the known risk factors for our outcome of interest?*

The known risk factors for Coronary Heart Disease (CHD) are as follows:

- Behaviour type A/B
- Age
- Cholesterol
- Systolic Blood Pressure
- BMI
- Smoking
- Corneal arcus

*c. How many persons are included?*

3154 middle-aged men, from 39 to 59 years of age, during the years 1960-1961 are included in this prospective cohort study.

*d. What is the overall risk or rate and prevalence of the disease in our cohort?*

The overall risk or rate and prevalence of the disease in our cohort is as follows:

```{r}
# Overall risk or rate
overall_rate <- table(di$chd69)

#calculate risk of CHD
overall_risk <- overall_rate / sum(overall_rate)

# extract the rate and risk into a data frame
chd_frame <- data.frame(
  "CHD Presence" = c("No", "Yes"),
  "Overall Rate" = c(as.matrix(overall_rate)[1], as.matrix(overall_rate)[2]),
  "Overall Risk" = c(as.matrix(overall_risk)[1], as.matrix(overall_risk)[2])
)
#print overall rate and risk into a table
knitr::kable(chd_frame, col.names = c("CHD Presence", "Overall Rate", "Overall Risk"))

```
                                 
## Analysis : 

The overall risk of Coronary Heart Disease (CHD) in the cohort is 0.08, which indicates that prevalence of the disease is 8% in the cohort.

# Question 3

## Overview: 

To solve this problem, we need to build an optimal prediction model for the outcome of Coronary Heart Disease (CHD)
using the available data. We will use logistic regression due to the binary nature of the outcome and select predictors that improve our predictions. Additionally, we will consider interaction terms and ensure that categorical variables are appropriately handled.

#### 3.a. Building the Optimal Prediction Model

**Step 1: Model Selection**

Logistic regression is suitable for predicting Coronary Heart Disease (CHD) because:

- Binary outcome: CHD is a binary outcome, meaning it can be either present (1) or absent (0). Logistic regression is designed to model binary outcomes.
- Multiple predictors: There are multiple known risk factors for CHD, and logistic regression can handle multiple predictor variables.
- Quantification of risk: Logistic regression can provide estimates of the probability of developing CHD based on the values of the predictor variables, which can be useful for risk assessment and decision-making. 

The `rms` package in R provides functions for regression modeling strategies, including logistic regression via the `lrm` function.

**Step 2: Variable Selection**

We start by fitting a full model that includes all potential predictors:

```{r}
dd <- datadist(di)
options(datadist="dd")
full_model <- lrm(chd69 ~ dibpat0f + age0 + cholmmol + sbp10 + bmi + smokerf + arcus0, data=di, x=TRUE, y=TRUE)
```

Next, we perform backward selection to remove variables that do not significantly contribute to the model (p > 0.05):

```{r}
bw_model <- fastbw(full_model, rule="p", sls=0.05)
vars_kept <- bw_model$names.kept
```

We then construct a final model using only the variables retained in the backward selection:

```{r}
final_formula <- as.formula(paste("chd69 ~", paste(vars_kept, collapse=" + ")))
final_model <- lrm(final_formula, data = di, x = TRUE, y = TRUE)
summary(final_model)
```

**Explanation**

- **Model Selection**: Logistic regression is appropriate for binary outcomes.
- **Variable Selection**: Backward selection helps in identifying the most significant predictors, ensuring that the model is not overfitted and only includes variables that contribute meaningfully to the prediction of CHD.

#### 3.b. Including Interaction Terms

We need to check if including interaction terms between certain predictors improves the model fit. When considering interaction terms in a logistic regression model, one needs to think which variables might have a combined effect on the outcome (Coronary Heart Disease) that's different from their individual effects. Here are some potential interaction terms along with their rationale:

- **Age and Cholesterol:** As people age, their cholesterol levels may have a greater impact on their risk of Coronary Heart Disease. This interaction term can help capture the potential synergistic effect of increasing age and cholesterol levels.
- **Smoking and Age:** Smoking is a well-known risk factor for Coronary Heart Disease, and its effects may be exacerbated with increasing age. This interaction term can help account for the potential increased risk of Coronary Heart Disease among older smokers.
- **BMI and Systolic Blood Pressure:** High blood pressure is often associated with obesity, and the combination of these two factors may increase the risk of Coronary Heart Disease more than either factor alone. This interaction term can help capture the potential additive effect of high BMI and systolic blood pressure.
- **Cholesterol and Systolic Blood Pressure:** High cholesterol and high blood pressure are both risk factors for Coronary Heart Disease, and their combined effect may be greater than the sum of their individual effects. This interaction term can help account for the potential synergistic effect of these two factors.
- **Corneal arcus and Age:** Corneal arcus is a sign of lipid deposition in the cornea, which may be associated with increased risk of Coronary Heart Disease. The effect of corneal arcus may be more pronounced in older individuals, making this interaction term a potential candidate.
- **Smoking and Cholesterol:** Smoking can increase cholesterol levels, and the combination of these two factors may increase the risk of Coronary Heart Disease more than either factor alone. This interaction term can help capture the potential additive effect of smoking and high cholesterol.
- **Age and BMI:** As people age, their BMI may have a greater impact on their risk of Coronary Heart Disease. This interaction term can help account for the potential increased risk of Coronary Heart Disease among older individuals with high BMI.

After exploring various models with various combinations of interaction terms along with the full model, we went through a model selection process using AIC to compare the goodness-of-fit. We ultimately chose the model including the interactions between `bmi` and `sbp10`, and between `age0` and `arcus0` as it gave the lowest AIC on comparing with every other model combination.

**Step 1: Fit a Model with Interaction Terms**

```{r}
interaction_model <- lrm(chd69 ~ dibpat0f + age0 + cholmmol + sbp10 + bmi + smokerf + arcus0 + bmi * sbp10 + age0 *
arcus0, data=di, x=TRUE, y=TRUE)
```

**Step 2: Compare Models**

We use the likelihood ratio test to compare the final model without interactions to the model with interactions:

```{r}
lrtest(final_model, interaction_model)
AIC(final_model)
AIC(interaction_model)
```

**Explanation**

- **Interaction Terms**: Interaction terms allow us to assess whether the effect of one predictor on the outcome depends on the level of another predictor. For example, the effect of BMI on CHD might vary depending on systolic blood pressure.
- **Model Comparison**: The likelihood ratio test helps determine if the addition of interaction terms significantly improves the model fit. Since the p-value is significant (p < 0.05), we include the interaction terms; otherwise, we would have retained the model without interactions. Coupled with the fact that the AIC was slightly better than the model without interactions though it adds a certain level of complexity given the additional number of parameters

#### 3.c. Calculating Predicted Risks

Once the final model is selected, we calculate the predicted probabilities of CHD for each individual in the dataset and add these predictions to the dataset.

**Step 1: Calculate Predicted Risks**

```{r}
di$predicted_risk <- predict(final_model, di, type="fitted")
```

**Explanation**

- **Predicted Risks**: These probabilities provide an estimate of each individual's risk of developing CHD based on
the predictor values in the model. This information can be crucial for further analysis, such as assessing model calibration or making risk-based decisions.


### Explanation

1. **Model Selection and Variable Selection**:
   - Started with a full logistic regression model.
   - Performed backward selection to identify significant predictors.

2. **Interaction Terms**:
   - Assessed interaction effects between `bmi` and `sbp10`, and between `age0` and `arcus0`.
   - Used likelihood ratio test to compare models with and without interactions.

3. **Predicted Risks**:
   - Calculated predicted probabilities of CHD for each individual and added them to the dataset.

This approach ensures that the final model is both statistically sound and practically useful for predicting CHD risk.

# Question 4

## Overview : 

## Code :

```{r echo=FALSE}

```

## Output : 

## Analysis : 

# Question 5

## Overview : 

## Code :

```{r echo=FALSE}

```

## Output : 

## Analysis : 

# Question 6

## Overview : 

## Code :

```{r echo=FALSE}

```

## Output : 

## Analysis : 

# Question 7

## Overview : 

## Code :

```{r echo=FALSE}

```

## Output : 

## Analysis : 

# Question 8

## Overview : 

## Code :

```{r echo=FALSE}

```

## Output : 

## Analysis : 

# Question 9

## Overview : 

## Code :

```{r echo=FALSE}

```

## Output : 

## Analysis : 

# Question 10

## Overview : 

## Code :

```{r echo=FALSE}

```

## Output : 

## Analysis : 

# Question 11

## Overview : 

## Code :

```{r echo=FALSE}

```

## Output : 

## Analysis : 

# Question 12

## Overview : 

## Code :

```{r echo=FALSE}

```

## Output : 

## Analysis : 

# Question 13

## Overview : 

## Code :

```{r echo=FALSE}

```

## Output : 

## Analysis : 
